---
title: 'Cross Site Request Forgery'
date: '游딉勇뀹eptiembre 09, 2020'
tags: '游 Seguridad,游눹Informatica'
fecha: '2021-09-09'
descripcion: ' Cross Site Request Forgery - Qu칠 es un ataque CSRF y c칩mo prevenirlo'
---

La falsificaci칩n de petici칩n en sitios cruzados, o CSRF por sus siglas en ingl칠s, se produce cuando un sitio o programa malicioso hace que el navegador de un usuario realice una acci칩n no deseada en un sitio de confianza cuando el usuario est치 autenticado. Cualquier acci칩n maliciosa se limita a la capacidad del sitio web en el que el usuario est치 autenticado.

Por ejemplo, Juan podr칤a entrar en su portal de banca online mientras revisa su correo electr칩nico. Mientras est치 all칤, puede hacer clic en un enlace de un correo electr칩nico de phishing (probablemente ofuscado por un sitio de acortamiento de enlaces) que incluir칤a una solicitud para que el banco de Juan transfiera dinero a una cuenta que el atacante controla.

Como Juan ya est치 autentificada por su banco, 칠ste realiza autom치ticamente la transacci칩n, creyendo que, al ser solicitada por el navegador de Juan , ella la ha autorizado.

## 쯈u칠 son las peticiones HTTP y las cookies?
Petici칩n HTTP GET
Se trata de una petici칩n que se utiliza para solicitar datos a un servidor web (por ejemplo, escribir una URL (solicitar un sitio web) que hace que se cargue).

## Solicitud HTTP POST
Se trata de una solicitud utilizada para enviar datos a un servidor web (por ejemplo, el env칤o de un formulario web).

Algunas solicitudes GET y POST se activan autom치ticamente, sin la interacci칩n del usuario (como la obtenci칩n de sugerencias de b칰squeda o la carga de contenido de im치genes con el atributo img src).

Cookies de sesi칩n
Las cookies de sesi칩n son una forma en que HTTP maneja el estado (ya que no lo hace de forma nativa). Los sitios web utilizan cookies de sesi칩n (que contienen un ID 칰nico) para identificar a los usuarios y conservar su sesi칩n.

Una vez configurada, el navegador del usuario env칤a la cookie al servidor con cada solicitud que realiza para identificar al usuario en el sitio.

Un atacante puede aprovechar la cookie para hacerse pasar por el usuario forzando el navegador del usuario a ejecutar una petici칩n. Si el usuario ya ha iniciado sesi칩n en el sitio, la cookie se enviar치 autom치ticamente con la solicitud.

## 쮺칩mo funciona la falsificaci칩n de petici칩n en sitios cruzados?
Para que un atacante pueda llevar a cabo un ataque CSRF, tienen que darse varias cosas:

Hay una acci칩n en la aplicaci칩n que el atacante quiere realizar - como cambiar una contrase침a, transferir fondos, etc.
No hay par치metros de solicitud impredecibles - el atacante puede adivinar (o conoce) todos los par치metros que la aplicaci칩n espera ver de este tipo de solicitud.
La acci칩n puede llevarse a cabo mediante una o varias peticiones HTTP y s칩lo se basa en las cookies para verificar que la petici칩n procede del usuario.
El CSRF puede afectar a las aplicaciones web que utilizan cookies, autenticaci칩n del navegador o certificados del lado del cliente para autenticar a los usuarios. B치sicamente, puede ocurrir en cualquier caso en el que la aplicaci칩n a침ada autom치ticamente las credenciales o la identidad de un usuario a una solicitud.

Un ataque CSRF puede aprovechar una solicitud GET o una solicitud POST (aunque la solicitud POST es m치s complicada y, por lo tanto, poco com칰n).

Cualquiera de las dos tiene que empezar con un atacante que enga침e a la v칤ctima para que cargue o env칤e la informaci칩n a una aplicaci칩n web. Esto puede tener lugar de varias maneras - por ejemplo, a trav칠s de un enlace de phishing.

Alternativamente, de forma similar al XSS (Cross-site scripting), el CSRF puede ser una vulnerabilidad almacenada. La CSRF almacenada ocurre cuando un atacante almacena el ataque en un campo que acepta HTML, como una etiqueta IMG o IFRAME. Esto significa que cualquier persona que vea la p치gina podr칤a verse afectada.  El exploit puede ser disfrazado como un enlace ordinario o escondido en una etiqueta de imagen.

Por ejemplo, como un enlace normal en una p치gina web: < a href="enlace malicioso">Darse de baja aqu칤< / a >

O, como una etiqueta de imagen:  < img src="enlace malicioso" width="0" height="0" border="0" >

## Ejemplo de CSRF
Imagina que tu banco (bank.com) procesa las transferencias mediante peticiones GET que incluyen varios par치metros (la identidad del destinatario de la transferencia y cu치nto quieres transferir).

Por ejemplo, si Jos칠 quiere enviar a su amigo Juan 10 euros, la solicitud podr칤a ser as칤

http:// bank.com/transfer?recipient=Juan&amount=10

La solicitud tambi칠n incluye una cookie de sesi칩n que identifica al propietario de la cuenta para que el banco sepa de d칩nde sacar el dinero.

Ahora, un atacante puede convencer a Jos칠 para que haga clic en un enlace que se parece a esto (pero que ha sido acortado por un acortador de URL o hipervinculado inteligentemente):

http:// bank.com/transfer?recipient=Hacker&amount=100000

Como Jos칠 ya ha iniciado la sesi칩n, su navegador env칤a su cookie con la solicitud, por lo que su banco cree que est치 solicitando la transferencia y 칠sta se lleva a cabo.

## C칩mo detener los ataques CSRF
Elija cuidadosamente sus marcos de trabajo
Utilice marcos de trabajo que hayan incorporado protecciones contra el CSRF, como .NET. La configuraci칩n correcta es clave. Si el marco de trabajo que est치 utilizando no tiene protecci칩n, puede a침adir protecci칩n con tokens Anti-CSRF.

## Utilizar tokens Anti-CSRF
Los tokens (tambi칠n conocidos como patrones de tokens de sincronizaci칩n) son una protecci칩n del lado del servidor en la que el servidor proporciona al navegador del usuario un token 칰nico, generado aleatoriamente, y comprueba en cada petici칩n si el navegador lo devuelve antes de realizar una petici칩n.

Este token se env칤a a trav칠s de un campo oculto y debe ser un n칰mero aleatorio no predecible que caduca al cabo de poco tiempo y no puede reutilizarse.

Dependiendo de la sensibilidad de la p치gina, se pueden utilizar diferentes tokens para cada solicitud, o simplemente para diferentes formularios. Los tokens deben ser comparados de forma segura (como por ejemplo comparando hashes) y no deben ser enviados en una petici칩n HTTP get para que no formen parte de la URL y no puedan filtrarse a trav칠s de la cabecera Referrer.
Utilizar el indicador SameSite en las cookies
La bandera SameSite marca una cookie para que s칩lo pueda ser enviada para peticiones que se originen en el mismo dominio.

B치sicamente, si www. bank .com quiere hacer una petici칩n a www.bank.com/ updatepassword, puede hacerlo. Pero si www.maliciousdomain.com quiere hacer una petici칩n a www. bank.com /updatepassword, no puede enviar la cookie de sesi칩n y por lo tanto no puede llevar a cabo el ataque.

La mayor칤a de los navegadores ahora soportan esta bandera, pero no todos. Deber칤a ser parte de una estrategia de defensa integral.

Practicar la defensa en profundidad
Puede implementar una serie de otros controles que, cuando se utilizan junto con otras medidas, pueden proporcionar protecci칩n contra el CSRF.

Por ejemplo, aqu칤 hay otras protecciones que puede poner en pr치ctica:

verificar el origen con cabeceras est치ndar (determinar de d칩nde procede la solicitud y a d칩nde va dirigida para asegurarse de que coinciden)
utilizar una cabecera de solicitud personalizada (para que sin la cabecera el sitio no acepte la solicitud)
doble env칤o de cookies (esencialmente un segundo par치metro generado aleatoriamente y desconocido -para el atacante- que un atacante tiene que enviar con una solicitud para que 칠sta tenga 칠xito).
Implicar al usuario en la transacci칩n
Para las acciones sensibles, como las transferencias de dinero o los cambios de contrase침as, exija al usuario que realice una acci칩n (como CAPTCHA, tokens de un solo uso o reautenticaci칩n).

Ejemplos de medidas que no funcionan
Transacciones de varios pasos: No importa cu치ntos pasos haya mientras el atacante pueda predecir/determinar cada uno.
HTTPS: Siempre es una buena idea, pero no hace nada para proteger contra CSRF.
Reescritura de URL: Esto evitar칤a que los atacantes adivinen el ID de sesi칩n de la v칤ctima durante un ataque CSRF, pero permitir칤a a un atacante verlo en la URL. Cambiar un defecto por otro no es una buena idea.
Usar una cookie secreta: Incluso una cookie secreta es enviada como parte de la solicitud, lo que significa que el atacante a칰n puede aprovecharla.
Aceptando s칩lo peticiones POST/evitando las peticiones GET: Las solicitudes POST falsificadas a칰n pueden ser utilizadas para ejecutar un ataque CSRF.
Otros nombres para CSRF

CSRF tambi칠n se conoce como XSRF, Sea Surf, Session Riding, Cross-Site Reference Forgery, Hostile Linking, One-Click Attack.